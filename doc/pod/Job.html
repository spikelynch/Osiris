<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>../Osiris/lib/Osiris/Job.pm</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:root@localhost" />
</head>

<body style="background-color: white">


<!-- INDEX BEGIN -->
<div name="index">
<p><a name="__index__"></a></p>

<ul>

	<li><a href="#name">NAME</a></li>
	<li><a href="#synopsis">SYNOPSIS</a></li>
	<li><a href="#description">DESCRIPTION</a></li>
	<li><a href="#metadata">METADATA</a></li>
	<li><a href="#methods">METHODS</a></li>
</ul>

<hr name="index" />
</div>
<!-- INDEX END -->

<p>
</p>
<h1><a name="name">NAME</a></h1>
<p>Osiris::Job</p>
<p>
</p>
<hr />
<h1><a name="synopsis">SYNOPSIS</a></h1>
<pre>
    my $job = Osiris::Job-&gt;new(
        user =&gt; $user,
        app =&gt; $app,
        id =&gt; $id,
    );</pre>
<pre>
    $job-&gt;set_status(status =&gt; $done);</pre>
<pre>
    $job-&gt;write;</pre>
<pre>
    my @files = $job-&gt;files;</pre>
<p>
</p>
<hr />
<h1><a name="description">DESCRIPTION</a></h1>
<p>A class representing a job - an Isis app, a set of parameters,
including one or more input files, and an output filename, and a User.</p>
<p>This class is used by the Dancer app to create and monitor jobs, and
by the daemon to run them.</p>
<p>Jobs have a status, which is stored in the user's joblist file. Takes
the following values:</p>
<dl>
<dt><strong><a name="new_value_at_creation" class="item">new - value at creation</a></strong></dt>

<dt><strong><a name="processing_set_when_the_isis_process_starts_running" class="item">processing - set when the Isis process starts running</a></strong></dt>

<dt><strong><a name="done_set_when_the_isis_process_completes_successfully" class="item">done - set when the Isis process completes successfully</a></strong></dt>

<dt><strong><a name="error_set_when_the_isis_process_completes_unsuccessfully" class="item">error - set when the Isis process completes unsuccessfully.</a></strong></dt>

</dl>
<p>NOTE: in this class, 'app' refers to an Osiris::App object, and 
'appname' refers to the object's name (the actual command line program's
name.)  When passing back a summary for the job, 'appname' is called 'app'.</p>
<p>All filenames are now relative to the working directory for this job.
This includes filenames used from previous jobs, which will have relative
paths like '../$OLD_JOB_ID/$FILENAME'</p>
<p>
</p>
<hr />
<h1><a name="metadata">METADATA</a></h1>
<p>Each job has the following metadata fields:</p>
<dl>
<dt><strong><a name="id" class="item">id</a></strong></dt>

<dt><strong><a name="status" class="item">status</a></strong></dt>

<dt><strong><a name="app" class="item">app</a></strong></dt>

<dd>
<pre>

=item user</pre>
<pre>

=item from (list of input files)</pre>
<pre>

=item to (list of output files)</pre>
<pre>

=item created (timestamp)</pre>
<pre>

=item started (timestamp)</pre>
<pre>

=item finished (timestamp)</pre>
</dd>
</dl>
<p>
</p>
<hr />
<h1><a name="methods">METHODS</a></h1>
<dl>
<dt><strong><a name="new" class="item">new(id =&gt; $id, dir =&gt; $dir, status =&gt; $status)</a></strong></dt>

<dd>
<p>Job objects are created by Osiris::User - either when it scans the user's
joblist, or adds a new job via the write_job method.</p>
</dd>
<dt><strong><a name="create_dir" class="item"><code>create_dir()</code></a></strong></dt>

<dd>
<p>Create this job's subdirectory in the user's working directory</p>
</dd>
<dt><strong><a name="working_dir" class="item">working_dir([file =&gt; $file])</a></strong></dt>

<dd>
<p>Returns the directory in which this job will be run.  If a file param is
passed in, returns the complete path to a file in the directory.</p>
</dd>
<dt><strong><a name="file_exists" class="item">file_exists(file =&gt; $relfile)</a></strong></dt>

<dd>
<p>Given a filepath relative to this job's working directory, check that
the file exists.  (Jobs can have input files from other jobs - this 
method needs to work for those too.)</p>
</dd>
<dt><strong><a name="write" class="item"><code>write()</code></a></strong></dt>

<dd>
<p>Writes out this job's XML</p>
<p>FIXME - this has to create the parameter and file lists itself</p>
<p>WARNING: this method was originally only used to create a job.  I am
adjusting things so that it can be used to rewrite a job (to update the
status etc) but am a bit worried that this will break a bunch of things.</p>
</dd>
<dt><strong><a name="set_status" class="item">set_status(status =&gt; $status)</a></strong></dt>

<dd>
<p>Writes this job's status to its user's job queue.  Note that this updates
the status for this object, but refers to the job by ID when saving the
joblist - trying to cover all bases.</p>
<p>It also sets timestamps as follows:</p>
<pre>
  'processing'             =&gt; sets the 'started' timestamp
  'done' and 'error'       =&gt; set the 'finished' timestamp</pre>
<p>When the status is set to 'done' it also scans the working dir for
files and updates the 'TO' field in the metadata if there is more than
one output file</p>
<p>It now rewrites the job's XML file.</p>
</dd>
<dt><strong><a name="add_parameters" class="item">add_parameters(parameters =&gt; \%params)</a></strong></dt>

<dd>
<p>Does any checking or conversion required on the parameters -
this will include parameter value checking, and making sure that
output files don't already exist etc.</p>
<p>This is now used for ALL parameters, as copying the input files
now happens outside this object.</p>
<p>The parameter '_annotations' can be used to store notes against
parameters.  Currently used to store 'parent' = job id from which
an input value was derived.</p>
</dd>
<dt><strong><a name="add_extras" class="item"><code>add_extras(%params)</code></a></strong></dt>

<dd>
<p>Adds one or more 'extra' parameters (like publication metadata)</p>
</dd>
<dt><strong><a name="timestamp" class="item"><code>timestamp()</code></a></strong></dt>

<dd>
<p>Returns a nicely-formatted timestamp</p>
</dd>
<dt><strong><a name="summary" class="item"><code>summary()</code></a></strong></dt>

<dd>
<p>Returns a hashref of this job's details, suitable for use in a job list:</p>
<dl>
<dt><strong><a name="id_item_created_item_started_item_finished_item_status_item_appname_item_user_item_from_item_to" class="item">id
=item created
=item started
=item finished
=item status
=item appname
=item user
=item from
=item to</a></strong></dt>

</dl>
<p>TODO: parent and child jobs?</p>
</dd>
<dt><strong><a name="label" class="item"><code>label()</code></a></strong></dt>

<dd>
<p>Returns a unique label for this job - id:appname</p>
</dd>
<dt><strong><a name="xml_file" class="item"><code>xml_file()</code></a></strong></dt>

<dd>
<p>Generates and returns the full path to the job's XML file</p>
</dd>
<dt><strong><a name="xml" class="item"><code>xml()</code></a></strong></dt>

<dd>
<p>Return the XML representation of this job</p>
</dd>
<dt><strong><a name="read_xml" class="item"><code>read_xml()</code></a></strong></dt>

<dd>
<p>Reads a job from the XML file in the user's working directory.</p>
<p>This also creates an App object.</p>
</dd>
<dt><strong><a name="load_app" class="item"><code>load_app()</code></a></strong></dt>

<dd>
<p>Load the job's App.</p>
</dd>
<dt><strong><a name="command" class="item"><code>command()</code></a></strong></dt>

<dd>
<p>Returns an arrayref of command-line arguments that Ptah (the processing
daemon) can pass to exec.</p>
</dd>
<dt><strong><a name="files" class="item"><code>files()</code></a></strong></dt>

<dd>
<p>Returns all the files associated with this job as a hashref:</p>
<pre>
    {
        print =&gt; $PRINTCONTENTS,
        inputs =&gt; [ { file =&gt; $filename, param =&gt; $param } ]
        outputs =&gt; [ { file =&gt; $filename, [ param =&gt; $param ] } ]
    }</pre>
<p>Note that there may be more than one file associated with a given
output field (ie FILENAME.odd.cub and FILENAME.even.cub) - this routine
tries to guess which ones match based on the job parameters.</p>
</dd>
<dt><strong><a name="_read_print_prt" class="item"><code>_read_print_prt()</code></a></strong></dt>

<dd>
<p>Attempts to read the job's PRINT.PRT file</p>
</dd>
<dt><strong><a name="_read_dir" class="item"><code>_read_dir()</code></a></strong></dt>

<dd>
<p>Reads the working directory for this job and returns a hashref of
filenames (relative to the working directory, with print.prt and the
job xml file filtered out)</p>
</dd>
</dl>

</body>

</html>
